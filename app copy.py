import asyncio
import logging

# –î–ª—è Jupyter Notebook (–µ—Å–ª–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞ RuntimeError: This event loop is already running)
try:
    import nest_asyncio
    nest_asyncio.apply()
except ImportError:
    pass

# ==============================
# 1. –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π
# ==============================
from aiogram import Bot, Dispatcher, types
from aiogram.filters.command import Command
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

# ========= LangChain, –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ë–î, –∑–∞–≥—Ä—É–∑—á–∏–∫–∏ –∏ —Ç.–¥. =========
from langchain.document_loaders import Docx2txtLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_chroma import Chroma
from langchain_gigachat.embeddings import GigaChatEmbeddings

# –î–ª—è LLM (Deepseek + LangChain)
from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser

# –î–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏
from operator import itemgetter

# --------------------------------------------------------------------------------
# 2. –ü–ê–†–ê–ú–ï–¢–†–´ –ü–†–û–ï–ö–¢–ê (–∑–∞–º–µ–Ω–∏—Ç–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# --------------------------------------------------------------------------------

# (a) Telegram API Token
TELEGRAM_API_TOKEN = "7527463118:AAGi1gWhksgn344ws0LBGbZrmMgEpDznIiE" 



# (b) DeepSeek (OpenAI —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π) ‚Äî –î–ª—è LLM
DEEPSEEK_API_KEY = "sk-236a0afa396441909beac5b2695851cd" # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á
DEEPSEEK_BASE_URL = "https://api.deepseek.com/beta"
DEEPSEEK_MODEL = "deepseek-chat"








# (c) GigaChatEmbeddings (–°–±–µ—Ä API)
GIGACHAT_CREDENTIALS = "Njc1NmEyNWEtNjIyMC00NzgxLTg1NDUtMWUzM2NjN2JhMDEwOmMyMmRjNmY3LWRlMTUtNDA5ZS1hYzQ0LTIyMmQxMzkyYTU3MQ==" # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π
GIGACHAT_SCOPE = "GIGACHAT_API_PERS"
VERIFY_SSL_CERTS = False  # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å–æ SSL, –æ—Å—Ç–∞–≤—å—Ç–µ False

# (d) –ü—É—Ç—å –∫ –≤–∞—à–µ–º—É docx-—Ñ–∞–π–ª—É
TEXT_FILE = "Rag_data.docx"

# (e) –ü–∞–ø–∫–∞ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã
PERSIST_DIRECTORY = "db_giga"

# --------------------------------------------------------------------------------
# 3. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# --------------------------------------------------------------------------------
logging.basicConfig(level=logging.INFO)

# --------------------------------------------------------------------------------
# 4. –ó–ê–ì–†–£–ó–ö–ê –ò –ü–†–ï–î–û–ë–†–ê–ë–û–¢–ö–ê –î–û–ö–£–ú–ï–ù–¢–ê
# --------------------------------------------------------------------------------
logging.info("–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç...")
docx_loader = Docx2txtLoader(TEXT_FILE)
pages = docx_loader.load()

logging.info(f"–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—Å—Ç—Ä–∞–Ω–∏—Ü) –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(pages)}")
logging.info(f"–ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:\n{pages[0].page_content[:200]}...")

# –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞_chunks
logging.info("–î–µ–ª–∞–µ–º —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã...")
splitter = RecursiveCharacterTextSplitter(chunk_size=1500, chunk_overlap=200)
chunks = splitter.split_documents(pages)
logging.info(f"–í—Å–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ (chunks) –ø–æ—Å–ª–µ —Ä–∞–∑–±–∏–µ–Ω–∏—è: {len(chunks)}")

# --------------------------------------------------------------------------------
# 5. –°–û–ó–î–ê–ù–ò–ï –í–ï–ö–¢–û–†–ù–û–ô –ë–ê–ó–´ (Chroma) –ò –ò–ù–î–ï–ö–°–ê–¶–ò–Ø
# --------------------------------------------------------------------------------
logging.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GigaChatEmbeddings –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã...")
embeddings = GigaChatEmbeddings(
    credentials=GIGACHAT_CREDENTIALS,
    scope=GIGACHAT_SCOPE,
    verify_ssl_certs=VERIFY_SSL_CERTS,
)

# –°–æ–∑–¥–∞—ë–º Chroma –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
vectorstore = Chroma.from_documents(
    documents=chunks,
    embedding=embeddings,
    persist_directory=PERSIST_DIRECTORY
)

# –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
retriever = vectorstore.as_retriever()

# --------------------------------------------------------------------------------
# 6. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–û–î–ï–õ–ò LLM (Deepseek)
# --------------------------------------------------------------------------------
logging.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º LLM (Deepseek ChatOpenAI —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)")
# llm = ChatOpenAI(
#     base_url=DEEPSEEK_BASE_URL,
#     model=DEEPSEEK_MODEL,
#     api_key=DEEPSEEK_API_KEY,
#     temperature=0,
#     streaming=True
# )



# from langchain_openai import ChatOpenAI
# from langchain_core.messages import HumanMessage, SystemMessage

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ ChatOpenAI (–∫–∞—Å—Ç–æ–º–Ω—ã–π API Hyperbolic)
HYPERBOLIC_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhbGV4YW5kZXJrcmVtZW5ldHNreTlAZ21haWwuY29tIiwiaWF0IjoxNzMzOTAzNjQzfQ.4amWmCEBthlO2VwO5GZDPzYrGt7lLDR8nT_Wi_JE2E0"
llm = ChatOpenAI(
    base_url="https://api.hyperbolic.xyz/v1",  # –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API
    api_key=HYPERBOLIC_API_KEY,
    model="meta-llama/Meta-Llama-3-70B-Instruct",  # –£–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å
    temperature=0.7,  # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    max_tokens=1024,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
)


# --------------------------------------------------------------------------------
# 7. –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ (–∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –∫–æ–¥–∞) + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ RAG
# --------------------------------------------------------------------------------
# –ú—ã –±–µ—Ä—ë–º –≤—Å—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏–∑ ¬´–º–∞–≥–∞–∑–∏–Ω–Ω–æ–≥–æ¬ª —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ + –¥–æ–ø–æ–ª–Ω—è–µ–º,
# —á—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
system_prompt_text = """
–Ø ‚Äì –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–µ–π—Å—è –Ω–∞ –∑–∞–∫—É—Å–∫–∞—Ö, –æ—Ä–µ—Ö–∞—Ö, —Å—É—à–µ–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏ –¥—Ä—É–≥–∏—Ö –ª–∞–∫–æ–º—Å—Ç–≤–∞—Ö. 
–ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø–æ–º–æ—á—å –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–æ–≤–∞—Ä—ã, –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–æ—Å—Ç–∞–≤–µ, –≤–∫—É—Å–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏, –∞ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ª—É—á—à–∏–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤: –ø–µ—Ä–µ–∫—É—Å–æ–≤, –≤–µ—á–µ—Ä–∏–Ω–æ–∫, –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞—Å–ª–∞–∂–¥–µ–Ω–∏—è –∏–∑—ã—Å–∫–∞–Ω–Ω—ã–º–∏ –≤–∫—É—Å–∞–º–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏:**
1. **–ì—Ä–µ–Ω–∫–∏**:
   - –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –≤–∫—É—Å—ã (—Å–º–µ—Ç–∞–Ω–∞ –∏ –ª—É–∫, –∫—Ä–∞—Å–Ω–∞—è –∏–∫—Ä–∞, —Ö–æ–ª–æ–¥–µ—Ü —Å —Ö—Ä–µ–Ω–æ–º –∏ –¥—Ä.).
   - –£–¥–æ–±–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫—É—Å–æ–≤ –Ω–∞ —Ö–æ–¥—É –∏–ª–∏ –∫ –ø–∏–≤—É.
2. **–û—Ä–µ—Ö–∏ –∏ —Å–º–µ—Å–∏**:
   - –ö–µ—à—å—é (–∂–∞—Ä–µ–Ω—ã–π).
   - –ê—Ä–∞—Ö–∏—Å –≤ –≥–ª–∞–∑—É—Ä–∏ (–±–µ–∫–æ–Ω, –±–∞—Ä–±–µ–∫—é –∏ –¥—Ä.).
   - –û—Ä–µ—Ö–æ–≤—ã–µ —Å–º–µ—Å–∏: ‚Äú–û—Ä–µ—Ö–æ–≤–æ–µ –∞—Å—Å–æ—Ä—Ç–∏‚Äù –∏ ‚Äú–û—Ä–µ—Ö–æ–≤—ã–π –∫–æ–∫—Ç–µ–π–ª—å‚Äù.
3. **–§—Ä—É–∫—Ç–æ–≤—ã–µ –∫—É–±–∏–∫–∏**:
   - –ú–∞–Ω–≥–æ, –º–∞—Ä–∞–∫—É–π—è, –∞—Ä–±—É–∑ –æ—Ç –±—Ä–µ–Ω–¥–∞ JES‚ÄôS ‚Äì –¥–ª—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —Å–º—É–∑–∏, –ª–∏–º–æ–Ω–∞–¥–æ–≤ –∏ –∫–æ–∫—Ç–µ–π–ª–µ–π.
4. **–ö—É–∫—É—Ä—É–∑–Ω—ã–µ —á–∏–ø—Å—ã**:
   - –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –Ω–∞—á–æ—Å —Å —Å–æ—É—Å–∞–º–∏ –∏ —Å–ø–µ—Ü–∏—è–º–∏, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ–∫—Å–∏–∫–∞–Ω—Å–∫–æ–π –∫—É—Ö–Ω–µ–π.
5. **–°—É—Ö–∏–µ —Å—ã—Ä—ã**:
   - ‚Äú–ë–æ—á–æ–Ω–æ–∫‚Äù –î–æ–Ω–¥—É–∫–æ–≤—Å–∫–∏–π –∏ CHEE CORN ‚Äì —Ö—Ä—É—Å—Ç—è—â–∏–µ, –ø–æ—Ä–∏—Å—Ç—ã–µ –∑–∞–∫—É—Å–∫–∏ —Å –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º —Å—ã—Ä–Ω—ã–º –≤–∫—É—Å–æ–º.
6. **–†—ã–±–Ω—ã–µ –∑–∞–∫—É—Å–∫–∏**:
   - –í—è–ª–µ–Ω–∞—è –≥–æ—Ä–±—É—à–∞ –∏ –ø–µ–ª—è–¥—å ‚Äì –∏–¥–µ–∞–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ –ø–∏–≤—É.
7. **–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –æ—Ä–µ—Ö–∏**:
   - –ú–∞–∫–∞–¥–∞–º–∏—è ‚Äì —Ä–æ—Å–∫–æ—à–Ω—ã–π, –º–∞—Å–ª—è–Ω–∏—Å—Ç—ã–π –æ—Ä–µ—Ö –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞.
   - –§–∏—Å—Ç–∞—à–∫–∏ (–∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ –∏ –∏—Ä–∞–Ω—Å–∫–∏–µ).
8. **–°—ã—Ä –ß–µ—á–∏–ª (–∫–æ—Å–∏—á–∫–∞)**:
   - –°—ã—Ä —Ä–∞—Å—Å–æ–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ –¥–ª—è –ø–æ–¥–∞—á–∏ –∫ –ø–∏–≤—É, —Å–∞–ª–∞—Ç–∞–º –∏–ª–∏ –∫–∞–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è –∑–∞–∫—É—Å–∫–∞.

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â—å: 
   "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –≤ –≤—ã–±–æ—Ä–µ –≤–∫—É—Å–Ω—ã—Ö –∑–∞–∫—É—Å–æ–∫ –∏ –ª–∞–∫–æ–º—Å—Ç–≤. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
2. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–æ–≤–∞—Ä–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
3. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑, —É—Ç–æ—á–Ω–∏, –∫–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –æ–Ω —Ö–æ—á–µ—Ç –∑–∞–∫–∞–∑–∞—Ç—å, –∏ —Ä–∞—Å—Å—á–∏—Ç–∞–π —Å—Ç–æ–∏–º–æ—Å—Ç—å.
4. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏–ª–∏ –æ–ø–ª–∞—Ç–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
   - –î–æ—Å—Ç–∞–≤–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 3-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.
   - –û–ø–ª–∞—Ç–∞ –≤–æ–∑–º–æ–∂–Ω–∞ –∫–∞—Ä—Ç–æ–π –∏–ª–∏ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏.

**–ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤:**
1. –í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∏–µ –≤–∫—É—Å—ã –≥—Ä–µ–Ω–æ–∫ —É –≤–∞—Å –µ—Å—Ç—å?"
   –û—Ç–≤–µ—Ç: "–£ –Ω–∞—Å –µ—Å—Ç—å –≥—Ä–µ–Ω–∫–∏ —Å–æ –≤–∫—É—Å–æ–º —Å–º–µ—Ç–∞–Ω—ã –∏ –ª—É–∫–∞, –∫—Ä–∞—Å–Ω–æ–π –∏–∫—Ä—ã, —Ö–æ–ª–æ–¥—Ü–∞ —Å —Ö—Ä–µ–Ω–æ–º –∏ –¥—Ä—É–≥–∏–µ."
2. –í–æ–ø—Ä–æ—Å: "–ö–∞–∫–∏–µ –æ—Ä–µ—Ö–∏ –≤—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ –¥–ª—è –≤–µ—á–µ—Ä–∏–Ω–∫–∏?"
   –û—Ç–≤–µ—Ç: "–î–ª—è –≤–µ—á–µ—Ä–∏–Ω–∫–∏ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥–æ–π–¥—É—Ç –æ—Ä–µ—Ö–æ–≤—ã–µ —Å–º–µ—Å–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ '–û—Ä–µ—Ö–æ–≤–æ–µ –∞—Å—Å–æ—Ä—Ç–∏' –∏–ª–∏ '–û—Ä–µ—Ö–æ–≤—ã–π –∫–æ–∫—Ç–µ–π–ª—å'. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∞—Ä–∞—Ö–∏—Å –≤ –≥–ª–∞–∑—É—Ä–∏ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤–∫—É—Å–∞–º–∏."
3. –í–æ–ø—Ä–æ—Å: "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –æ—Ä–µ—Ö–∏?"
   –û—Ç–≤–µ—Ç: "–î–∞, —É –Ω–∞—Å –µ—Å—Ç—å –º–∞–∫–∞–¥–∞–º–∏—è –∏ —Ñ–∏—Å—Ç–∞—à–∫–∏ –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞."

**–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:**
1. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω –æ—Ç–≤–µ—Ç–æ–º: 
   "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å."
2. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: 
   "–í–∞—à –∑–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: [—Å—É–º–º–∞]. –û–∂–∏–¥–∞–π—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 3-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π."

---

–ü—Ä–∏ —ç—Ç–æ–º —Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
–ï—Å–ª–∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ü—Ä–∏–¥—É–º–∞–π –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –¥–æ–ª–µ–π —é–º–æ—Ä–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–æ—Ç–æ—Ä—ã–π —É —Ç–µ–±—è –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞.
–ü—Ä–∏–º–µ—Ä: ‚Äú–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∫–∏–ª–æ–≥—Ä–∞–º–º –≥–≤–æ–∑–¥–µ–π?‚Äù "–£ –Ω–∞—Å –≥–≤–æ–∑–¥–∏ –Ω–µ –ø—Ä–æ–¥–∞—é—Ç—Å—è, –Ω–æ –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∑–∞—Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∫—É—Å–∏—Å—Ç—å, —É –Ω–∞—Å –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω—ã–µ —Å–Ω—ç–∫–∏! 
–ó–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ - –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–∞–π—Ç!üòÄ
"""

# --------------------------------------------------------------------------------
# 8. –°–û–ó–î–ê–Å–ú –ó–ê–ì–û–¢–û–í–ö–£ (PromptTemplate) –î–õ–Ø RAG
# --------------------------------------------------------------------------------
template = """
{system_prompt}

–ö–æ–Ω—Ç–µ–∫—Å—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞, –Ω–µ —Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏–∫–æ–º): 
{context}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
{question}

–û—Ç–≤–µ—Ç:
"""

prompt = PromptTemplate(
    input_variables=["system_prompt", "context", "question"],
    template=template,
)

parser = StrOutputParser()

# --------------------------------------------------------------------------------
# 9. –°–ë–û–†–ö–ê –¶–ï–ü–û–ß–ö–ò –î–õ–Ø RAG
# --------------------------------------------------------------------------------
# –õ–æ–≥–∏–∫–∞: –ø–æ–ª—É—á–∞–µ–º "question" –∏–∑ —á–∞—Ç–∞ ‚Üí –∏—â–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã ‚Üí —Ñ–æ—Ä–º–∏—Ä—É–µ–º prompt ‚Üí –≤—ã–∑—ã–≤–∞–µ–º LLM ‚Üí –ø–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
def build_rag_chain(system_text: str):
    """–°–æ–∑–¥–∞—ë—Ç ¬´—Ü–µ–ø–æ—á–∫—É¬ª, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ RAG."""
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º ¬´—Ü–µ–ø–æ—á–∫—É¬ª –≤ —Å—Ç–∏–ª–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω–≤–µ–π–µ—Ä–∞
    return (
        {
            "context": itemgetter("question") | retriever,  # –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            "question": itemgetter("question"),
            "system_prompt": lambda x: system_text,          # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç
        }
        | prompt
        | llm
        | parser
    )

chain = build_rag_chain(system_prompt_text)

# --------------------------------------------------------------------------------
# 10. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
# --------------------------------------------------------------------------------
def chunk_text(text: str, max_size: int = 4096):
    """–†–∞–∑–¥–µ–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª–∏–Ω–æ–π –Ω–µ –±–æ–ª–µ–µ max_size."""
    return [text[i : i + max_size] for i in range(0, len(text), max_size)]

# --------------------------------------------------------------------------------
# 11. –ù–ê–°–¢–†–û–ô–ö–ê –ë–û–¢–ê (aiogram 3.7+)
# --------------------------------------------------------------------------------
bot = Bot(
    token=TELEGRAM_API_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()

# --------------------------------------------------------------------------------
# 12. –ö–ù–û–ü–ö–ò
# --------------------------------------------------------------------------------
def get_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏."""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–û –º–∞–≥–∞–∑–∏–Ω–µ")],
            [KeyboardButton(text="–ü–æ–º–æ—â—å")],
            [KeyboardButton(text="–°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥")],
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )
    return keyboard

# --------------------------------------------------------------------------------
# 13. –ö–û–ú–ê–ù–î–´ /start –∏ /reset
# --------------------------------------------------------------------------------
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    logging.info(f"[START] {message.text} –æ—Ç {message.from_user.id}")
    await message.answer(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –º–∞–≥–∞–∑–∏–Ω –∑–∞–∫—É—Å–æ–∫ –∏ –ª–∞–∫–æ–º—Å—Ç–≤!\n\n"
        "–Ø ‚Äî –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –ü–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å –≤–∫—É—Å–Ω—ã–µ –∑–∞–∫—É—Å–∫–∏, –æ—Ä–µ—Ö–∏, —Å—É—à–µ–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –ª–∞–∫–æ–º—Å—Ç–≤–∞.\n"
        "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫.\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é.\n"
        "/start ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–Ω–æ–≤–∞.",
        reply_markup=get_keyboard()
    )

@dp.message(Command("reset"))
async def cmd_reset(message: types.Message):
    logging.info(f"[RESET] –°–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞ –æ—Ç {message.from_user.id}")
    await message.answer("–¢–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω. –ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ!", reply_markup=get_keyboard())

# --------------------------------------------------------------------------------
# 14. –û–ë–†–ê–ë–û–¢–ö–ê –í–°–ï–• –î–†–£–ì–ò–• –°–û–û–ë–©–ï–ù–ò–ô
# --------------------------------------------------------------------------------
@dp.message()
async def handle_message(message: types.Message):
    user_text = message.text.strip()
    if not user_text:
        logging.info("–ü–æ–ª—É—á–µ–Ω–æ –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º.")
        return

    logging.info(f"[MSG] –û—Ç {message.from_user.id}: {user_text}")

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ ¬´–∫–Ω–æ–ø–æ—á–Ω—ã—Ö¬ª –∑–∞–ø—Ä–æ—Å–æ–≤
    if user_text == "–û –º–∞–≥–∞–∑–∏–Ω–µ":
        await message.answer(
            "–ú—ã ‚Äî –∫–æ–º–ø–∞–Ω–∏—è, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∞—è—Å—è –Ω–∞ –∑–∞–∫—É—Å–∫–∞—Ö, –æ—Ä–µ—Ö–∞—Ö, —Å—É—à–µ–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏ –¥—Ä—É–≥–∏—Ö –ª–∞–∫–æ–º—Å—Ç–≤–∞—Ö. "
            "–£ –Ω–∞—Å –≤—ã –Ω–∞–π–¥–µ—Ç–µ —à–∏—Ä–æ–∫–∏–π –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –≤–∫—É—Å–Ω—ã—Ö –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤."
        )
        return
    elif user_text == "–ü–æ–º–æ—â—å":
        await message.answer(
            "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Ç–æ–≤–∞—Ä–∞—Ö –∏–ª–∏ —É—Å–ª—É–≥–∞—Ö."
        )
        return
    elif user_text == "–°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥":
        await cmd_reset(message)
        return

    # –ò–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ –Ω–∞—à—É RAG-—Ü–µ–ø–æ—á–∫—É
    try:
        response = chain.invoke({"question": user_text})
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ü–µ–ø–æ—á–∫–∏ LLM: {e}")
        response = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ."

    # –û—Ç–ø—Ä–∞–≤–∏–º –æ—Ç–≤–µ—Ç –≤ Telegram, —É—á–∏—Ç—ã–≤–∞—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤
    for chunk in chunk_text(response):
        await message.answer(chunk)

# --------------------------------------------------------------------------------
# 15. –ó–ê–ü–£–°–ö –ë–û–¢–ê
# --------------------------------------------------------------------------------
async def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî –∑–∞–ø—É—Å–∫ polling."""
    logging.info("–ó–∞–ø—É—Å–∫ Telegram-–±–æ—Ç–∞...")
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main())
